<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head profile="http://purl.org/NET/erdf/profile">
    <META http-equiv="Content-Type" content="text/html; charset=utf-16">
    <title>
					mca blog
					
									[conflate.ashx]
								</title>
    <link rel="alternate" type="application/x-wiki" title="Edit this blog" href="http://amundsen.com/blog/edit/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for mca blog" href="../feed/index.html">
    <link rel="stylesheet" type="text/css" href="http://amundsen.com/server/conflate/?/xcs/blogging/css/blogging.css,/xcs/blogging/css/blogging-layout.css,/xcs/blogging/css/blogging-iran-election.css">
    <link rel="search" type="application/opensearchdescription+xml" title="MikeAmundsen and friends" href="http://wego-wego.appspot.com/friendfeed/mamund/osd/">
    <link rel="schema.rdfs" href="http://www.w3.org/2000/01/rdf-schema#">
    <link rel="schema.dc" href="http://purl.org/dc/elements/1.1/">
    <link rel="schema.foaf" href="http://xmlns.com/foaf/0.1/">
    <link rel="schema.bio" href="http://vocab.org/bio/0.1/">
    <link rel="schema.contact" href="http://www.w3.org/2000/10/swap/pim/contact#">
    <link rel="schema.air" href="http://www.daml.org/2001/10/html/airport-ont#">
    <link rel="schema.wn" href="http://xmlns.com/wordnet/1.6/">
    <link rel="schema.rss" href="http://purl.org/rss/1.0/">
    <link rel="schema.terms" href="http://purl.org/dc/terms/">
    <link rel="schema.rel" href="http://purl.org/vocab/relationship/">
    <link rel="schema.geo" href="http://www.w3.org/2003/01/geo/wgs84_pos#">
    <link rel="schema.aff" href="http://purl.org/vocab/affiliations/0.1/">
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <link rel="schema.org" href="http://purl.org/vocab/organizations/0.1/">
    <link rel="schema.psych" href="http://purl.org/vocab/psychometric-profile/">
    <link rel="schema.doap" href="http://usefulinc.com/ns/doap#">
    <style type="text/css">
					form
					{
					font-size:small;
					padding:.3em;
					text-align:center;
					}
					input
					{
					font-size:x-small;
					}
					#twitter_div
					{
					/*
					width:95%
					padding:.2em;
					border:1px solid black;
					*/
					}
					#twitter_div h2
					{
					margin:0;
					padding:0;
					float:right;
					}
					.twitter-title
					{

					}
					#twitter_update_list
					{
					font-family:monospace;
					list-style:none;
					margin:0;
					padding:0;
					float:none;
					clear:both;
					}
					#twitter_update_list li
					{
					border:1px solid silver;
					background-color:#e6e6e6;
					margin:.2em .2em;
					}
					.twitter-link
					{
					display:block;
					float:right;
					margin-right: .7em;
					}
					#twitter_div a
					{
					text-decoration:none;
					}
					#twitter_div a:hover
					{
					text-decoration:underline;
					}
					.empty
					{
					float:none;
					clear:both;
					visibility:hidden;
					margin:0;
					padding:0;
					}
				</style><script type="text/javascript" src="http://amundsen.com/server/conflate/?/xcs/blogging/scripts/blogging.js,/lib/jscap/jcap.js,/lib/jscap/md5.js">//</script></head>
  <body>
    <div id="wrap">
      <div id="header">
        <h1><a href="../index.html" title="home page">mca blog</a></h1>
        <p class="title-desc">life in lowercase</p>
      </div>
      <div id="nav">
        <ul>
          <li><a href="../index.html" title="home page">Home</a></li>
          <li><a href="../categories/index.html" title="blog categories">Categories</a></li>
          <li><a href="../websites/index.html" title="intersting web sites">Web Sites</a></li>
          <li><a href="index.html" title="browse the archives">Archives</a></li>
        </ul>
      </div>
      <div id="main">
        <h2 class="dc-title">conflate.ashx</h2>
        <div class="weblog">
          <div class="wb-header"><span class="foaf-maker" style="display:none;"><a href="http://www.amundsen.com/blog/author/mamund" title="Posted by mamund">mamund</a></span><span class="logdate" style="margin-left:1em;">2007-10-23 @ 17:38</span><span class="permalink"><a href="426.html" title="perma-link">#</a></span></div>
          <div class="dc-description"><p>i've been dealing with *lots* of external resources w/ my current round of projects. several .JS files, several .CSS files. all need to be loaded for a page and that can take some time on complex pages. i've contemplated building an offline tool that combines them for production use, but that would require some versioning and mods on our production codebase that will take too much time.</p>
<p>instead, i whipped up an ASP.NET handler script (<code>conflate.ashx</code>) that does the job for me. it can sit in the root of any of our production apps as a stand alone script and does not interfere with anything. i just dropped it on our stagin server and it works like a champ! here's the full code set:</p>
<pre class="code">
&lt;%@ WebHandler Language="C#" Class="Conflate" %&gt;

/************************************************************************
 * 
 * title:   conflate.ashx
 * version: 1.0 - 2007-10-23 (mca)
 * 
 * usage:   "conflate.ashx?/folder/path/file1.js,/folder/path/file2.js,..."
 *          "conflate.ashx?/folder/path/file1.css,/folder/path/file2.css,..."
 * 
 * notes:   returns a single representation which is a combination of csv list
 *          inserts "error loading ..." msg if file was not found.
 *          ignores "empty" filenames (no load attempts, no errors)
 *          stores results in asp.net cache w/ file dependencies
 *          you modify expires var to control Cache-Control/Expires headers
 *          
 *************************************************************************/ 
using System;
using System.Web;

using System.IO;
using System.Text;
using System.Web.Caching;

public class Conflate : IHttpHandler 
{
    const double expires = 60 * 60 * 24 * 30;   // 30 days
    const string cache_control_fmt = "public,max-age:{0}";
    const string expires_fmt = "{0:ddd dd MMM yyyy HH:mm:ss} GMT";
    const string load_err_fmt = "/* error loading {0} */\n";
    
    public void ProcessRequest(HttpContext ctx)
    {
        string files = (ctx.Request.Url.Query.Length &gt; 0 ? ctx.Request.Url.Query.Substring(1) : string.Empty);
        if (files.Length &gt; 0)
        {
            string data = LoadFiles(ctx, files.Split(','));

            ctx.Response.Write(data);
            ctx.Response.StatusCode = 200;
            ctx.Response.ContentType = (files.IndexOf(".js") != -1 ? "text/javascript" : "text/css");

            if (expires != 0)
            {
                ctx.Response.AddHeader("Cache-Control", string.Format(cache_control_fmt, expires));
                ctx.Response.AddHeader("Expires", string.Format(expires_fmt, System.DateTime.UtcNow.AddSeconds(expires)));
            }
        }
        else
        {
            ctx.Response.ContentType = "text/plain";
            ctx.Response.StatusCode = 404;
            ctx.Response.Write("\n");
        }
        ctx.Response.End();
    }

    public bool IsReusable
    {
        get
        {
            return false;
        }
    }

    private string LoadFiles(HttpContext ctx, string[] files)
    {
        string data = (string)ctx.Cache.Get(ctx.Request.RawUrl);
        
        if (data == null)
        {
            string cached = string.Empty;
            string[] fnames = (string[])files.Clone();
            StringBuilder sb = new StringBuilder();

            for (int i = 0; i &lt; files.Length; i++)
            {
                if (files[i].Trim() != string.Empty)
                {
                    files[i] = ctx.Server.MapPath(files[i]);
                    if (File.Exists(files[i]))
                    {
                        using (TextReader tr = new StreamReader(files[i]))
                        {
                            sb.AppendLine(tr.ReadToEnd());
                        }
                        cached += files[i] + ",";
                    }
                    else
                    {
                        sb.AppendFormat(load_err_fmt, fnames[i]);
                    }
                }
            }
            
            data = sb.ToString();
            
            ctx.Cache.Add(
                ctx.Request.RawUrl,
                data,
                new CacheDependency(cached.Substring(0,cached.Length-1).Split(',')),
                Cache.NoAbsoluteExpiration,
                Cache.NoSlidingExpiration,
                CacheItemPriority.Normal,
                null);
        }

        return data;
    }
}
</pre>
</div>
          <p class="category"><a href="index.html%3Fcategory=5.html" title="more from code...">code</a></p>
          <hr><a id="comments"></a><script>
						var idcomments_acct = 'b941b488f39712a0d6409992a0d7fc47';
						var idcomments_post_id;
						var idcomments_post_url;
					</script><span id="IDCommentsPostTitle" style="display:none"></span><script type="text/javascript" src="http://www.intensedebate.com/js/genericCommentWrapperV2.js"></script></div>
        <div> </div>
      </div>
      <div id="sidebar">
        <h4>categories</h4>
        <ul>
          <li><a href="index.html%3Fcategory=33.html">Systems</a></li>
          <li><a href="index.html%3Fcategory=32.html">CA</a></li>
          <li><a href="index.html%3Fcategory=31.html">IoT</a></li>
          <li><a href="index.html%3Fcategory=30.html">ALPS</a></li>
          <li><a href="index.html%3Fcategory=29.html">API</a></li>
          <li>[<a href="../categories/index.html%3Fall.html" title="view all categories">all</a>]</li>
        </ul>
        <h4>websites</h4>
        <ul>
          <li><a href="../websites/32.html">Untangled</a></li>
          <li><a href="../websites/31.html">Anne’s Weblog</a></li>
          <li><a href="../websites/30.html">exyus</a></li>
          <li><a href="../websites/29.html">Random Stuff</a></li>
          <li><a href="../websites/28.html">JScript Blog</a></li>
          <li>[<a href="../websites/index.html%3Fall.html" title="view all websites">all</a>]</li>
        </ul>
        <h4>archives</h4>
        <ul>
          <li><a href="index.html%3Ftoday.html" title="today's posts">today</a></li>
          <li><a href="index.html%3Fyesterday.html" title="yesterday's posts">yesterday</a></li>
          <li><a href="index.html%3Fthisweek.html" title="this weeks's posts">this week</a></li>
          <li><a href="index.html%3Flastweek.html" title="last week's posts">last week</a></li>
          <li><a href="index.html%3Fthismonth.html" title="this month's posts">this month</a></li>
          <li><a href="index.html%3Flastmonth.html" title="last month's posts">last month</a></li>
          <li>
								[<a href="index.html" title="browse the archives">browse</a>]
							</li>
        </ul>
        <div> </div>
        <div><xscript type="text/javascript" src="http://plancast.com/goodies/widgets/sidebar/1/15731">// plancast</xscript></div>
        <div id="twitter_div">
          <h4>my tweets</h4>
          <ul id="twitter_update_list"></ul>
          <div class="twitter-link"><a href="http://twitter.com/mamund" title="follow me on Twitter">
									follow me
								</a></div>
          <hr class="empty">
        </div>
      </div>
      <div id="ads" style="text-align:center;"><script type="text/javascript">
							google_ad_client = "pub-2944238157647009";
							google_ad_width = 728;
							google_ad_height = 90;
							google_ad_format = "728x90_as";
							google_ad_type = "text";
							//2007-08-10: amundsen.com
							google_ad_channel = "2960096544";
							google_color_border = "000000";
							google_color_bg = "F0F0F0";
							google_color_link = "000000";
							google_color_text = "000000";
							google_color_url = "000000";
						</script><script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script></div>
      <div id="footer">
        <p>Copyright © 2007-2010 amundsen.com, inc. All rights reserved.</p>
      </div>
    </div><script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script><script type="text/javascript" src="http://twitter.com/statuses/user_timeline/mamund.json?callback=twitterCallback2&amp;count=5"></script><script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">
					_uacct = "UA-2399548-1";
					urchinTracker();
				</script></body>
</html>