<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head profile="http://purl.org/NET/erdf/profile">
    <META http-equiv="Content-Type" content="text/html; charset=utf-16">
    <title>
					mca blog
					
									[DOCTR: a better approach to transactions over HTTP]
								</title>
    <link rel="alternate" type="application/x-wiki" title="Edit this blog" href="http://amundsen.com/blog/edit/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for mca blog" href="../feed/index.html">
    <link rel="stylesheet" type="text/css" href="http://amundsen.com/server/conflate/?/xcs/blogging/css/blogging.css,/xcs/blogging/css/blogging-layout.css,/xcs/blogging/css/blogging-iran-election.css">
    <link rel="search" type="application/opensearchdescription+xml" title="MikeAmundsen and friends" href="http://wego-wego.appspot.com/friendfeed/mamund/osd/">
    <link rel="schema.rdfs" href="http://www.w3.org/2000/01/rdf-schema#">
    <link rel="schema.dc" href="http://purl.org/dc/elements/1.1/">
    <link rel="schema.foaf" href="http://xmlns.com/foaf/0.1/">
    <link rel="schema.bio" href="http://vocab.org/bio/0.1/">
    <link rel="schema.contact" href="http://www.w3.org/2000/10/swap/pim/contact#">
    <link rel="schema.air" href="http://www.daml.org/2001/10/html/airport-ont#">
    <link rel="schema.wn" href="http://xmlns.com/wordnet/1.6/">
    <link rel="schema.rss" href="http://purl.org/rss/1.0/">
    <link rel="schema.terms" href="http://purl.org/dc/terms/">
    <link rel="schema.rel" href="http://purl.org/vocab/relationship/">
    <link rel="schema.geo" href="http://www.w3.org/2003/01/geo/wgs84_pos#">
    <link rel="schema.aff" href="http://purl.org/vocab/affiliations/0.1/">
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <link rel="schema.org" href="http://purl.org/vocab/organizations/0.1/">
    <link rel="schema.psych" href="http://purl.org/vocab/psychometric-profile/">
    <link rel="schema.doap" href="http://usefulinc.com/ns/doap#">
    <style type="text/css">
					form
					{
					font-size:small;
					padding:.3em;
					text-align:center;
					}
					input
					{
					font-size:x-small;
					}
					#twitter_div
					{
					/*
					width:95%
					padding:.2em;
					border:1px solid black;
					*/
					}
					#twitter_div h2
					{
					margin:0;
					padding:0;
					float:right;
					}
					.twitter-title
					{

					}
					#twitter_update_list
					{
					font-family:monospace;
					list-style:none;
					margin:0;
					padding:0;
					float:none;
					clear:both;
					}
					#twitter_update_list li
					{
					border:1px solid silver;
					background-color:#e6e6e6;
					margin:.2em .2em;
					}
					.twitter-link
					{
					display:block;
					float:right;
					margin-right: .7em;
					}
					#twitter_div a
					{
					text-decoration:none;
					}
					#twitter_div a:hover
					{
					text-decoration:underline;
					}
					.empty
					{
					float:none;
					clear:both;
					visibility:hidden;
					margin:0;
					padding:0;
					}
				</style><script type="text/javascript" src="http://amundsen.com/server/conflate/?/xcs/blogging/scripts/blogging.js,/lib/jscap/jcap.js,/lib/jscap/md5.js">//</script></head>
  <body>
    <div id="wrap">
      <div id="header">
        <h1><a href="../index.html" title="home page">mca blog</a></h1>
        <p class="title-desc">life in lowercase</p>
      </div>
      <div id="nav">
        <ul>
          <li><a href="../index.html" title="home page">Home</a></li>
          <li><a href="../categories/index.html" title="blog categories">Categories</a></li>
          <li><a href="../websites/index.html" title="intersting web sites">Web Sites</a></li>
          <li><a href="index.html" title="browse the archives">Archives</a></li>
        </ul>
      </div>
      <div id="main">
        <h2 class="dc-title">DOCTR: a better approach to transactions over HTTP</h2>
        <div class="weblog">
          <div class="wb-header"><span class="foaf-maker" style="display:none;"><a href="http://www.amundsen.com/blog/author/mamund" title="Posted by mamund">mamund</a></span><span class="logdate" style="margin-left:1em;">2010-01-05 @ 22:02</span><span class="permalink"><a href="1024.html" title="perma-link">#</a></span></div>
          <div class="dc-description"><p>
<a href="http://www.flickr.com/photos/subliminal/1404241128/" title="the transaction">
<img src="http://farm2.static.flickr.com/1411/1404241128_0e91bba4bb_s.jpg" align="right" class="inline" />
</a>
  I've been contemplating transactions quite a bit lately. The examples of "transactions over HTTP" I've seen appear to be strenuous
  attempts to force state-ful <a href="http://en.wikipedia.org/wiki/ACID" title="ACID (atomicity, consistency, isolation, durability)">ACID</a> and 
  <a href="http://en.wikipedia.org/wiki/Two_phase_commit" title="The two-phase commit protocol (2PC)">2PC</a> patterns originally designed for local area networks
  onto a loosely-coupled, stateless, representation-based application protocol running over an unreliable distributed network. 
  I understand there are application models that specifically define a "final commit" that must be generated by the client application (e.g. bidding models that
  line up a series of partners and then require a final review and commit before proceeding). That case is not what I'm interested in here. Instead
  I am focusing on classic 2PC-type implementations over HTTP that ignore the realities of long-running operations over a distributed network.
</p>
<blockquote>
<p>
  The typical conversation thread, real or virtual, about transactions over HTTP goes something like this (elided for brevity):
  <dl>
    <dt>"You don't want transactions over HTTP"</dt>
    <dd>But I need to organize number of steps into a single unit I can deal with easily.</dd>
    <dt>"OK, but you <em>don't need</em> transactions over HTTP"</dt>
    <dd>But I need the ability to back out changes in multiple locations safely and consistently.</dd>
    <dt>"OK, but you <em><b>can't do</b></em> transactions over HTTP!"</dt>
    <dd>Really?</dd>
  </dl>
  And here the topic usually dies or descends into a heated debate.
</p>
</blockquote>
<p>
  A better approach is to expose an HTTP-compliant transaction service interface (TSI) that takes advantage of the protocol's inherent architectural
  style. Transactions over HTTP should be <em>optional</em>, <em>discoverable</em>, <em>negotiable</em>, based on <em>optimistic commits</em>, and (in the case of failures) use 
  <em>compenstating request</em>s as a way to reverse previous work.
</p>
<h4>Clearing things up</h4>
<p>
  First, I think it's true that 2PC-style transactions over HTTP are not needed.
  Two-Phase Commit may be important on the server-side <em>behind</em> the HTTP interface between the client and server, but there
  is no reason to expose them to HTTP clients; they don't care what goes on at the server. Clients just want a 2xx response
  to their request.
</p>
<p>
  Second, I agree there are times when it's important to have a way to safely cancel long-running operations that span multiple HTTP conversations.
  For example, a server that accepts a "buy" order from a client may need to interact with several other servers over HTTP in order to complete
  the required stock adjustments, arrange shipping, and confirm payment details. Note however, in my example, the "client" doing the "transacted work" is
  really the server accepting the initial request. Again, the original client doesn't give a hoot about any work going on behind the scenes no matter
  how many servers are involved. Lastly, while there is a need for handling failures in an encapsulated request chain (the "unit of work"),
  ACID/2PC is not appropriate over a distributed network. Instead, servers should implement and expose 
  <a href="http://www.rgoarchitects.com/Files/SOAPatterns/Saga.pdf" title="5.4 Saga">Saga</a>-type compenstating requests.
</p>
<h4>A better approach</h4>
<p>
  The way to handle transactions over HTTP is to think about them differently. The HTTP application protocol is than a 
  <a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm" title="CHAPTER 5 - Representational State Transfer (REST)">uniform interface</a>.
  Another important aspect of HTTP is reliance on <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" title="14 - Header Field Definitions">control data</a>
  that clients and servers use to share additional information about the associated message, implement runtime discovery, safely add optional service extensions,
  and negotiate preferences on how each party should treat the message body. One example of leveraging control data is implementing optimistic concurrency (also know as
  <a href="http://www.w3.org/1999/04/Editing/" title="Detecting the Lost Update Problem Using Unreserved Checkout">unreserved checkout</a>) over a distributed network
  via the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19" title="14.19 ETag"><code>ETag</code></a> header.
</p>
<p>
  It is important to leverage the protocol's features and take advantage of it's architectural strengths
  in order to define and expose a transaction service interface that is "HTTP-compliant."
</p>
<p>
  <em>
    So, what would an "HTTP-compliant" transaction interface look like to clients and servers?
  </em>
</p>
<h4>Optional, Discoverable, and Negotiable</h4>
<p>
  The service should be optional. Requiring clients to know about and implement the service details ahead of time is a barrier to adoption and runs counter to the tenets of HTTP.
  Rather, servers should be able to advertise support for transactions and clients should be able to discover that support. This can be done using the 
  <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.2" tile="9.2 - OPTIONS"><code>OPTIONS</code></a> method and two new headers: 
  <code>Accept-Trans</code> for requests and <code>Content-Trans</code> for responses.
  These new headers should work like the existing
  <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1" title="14.1 - Accept"><code>Accept</code></a> and 
  <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17" title="14.17 - Content-Type"><code>Content-Type</code></a> headers. 
  Servers can use the headers to advertise support for one or more transaction implementations and clients can use them negotiate 
  transaction implementation preferences. Extensions could be added and might include things like <code>required=true|false</code>, <code>max-ttl={msec}</code>, <code>min-ttl={msec}</code>, 
  and other implementation-specific options.
</p>
<h4>Optimistic</h4>
<p>
  Clients should not need to execute a second "commit" request in order to complete a unit of work. Instead, servers should always assume the client
  wants the work to complete unless explicitly told otherwise and should do so as soon as possible (or within specified time frames). Of course, servers are free to do whatever they wish
  in order to track and control the progress of work outside the HTTP request chain and return 4xx or 5xx response codes whenever appropriate.
</p>
<h4>Compensated</h4>
<p>
  Failed or cancelled requests within a unit of work should be handled via compenstating requests. Enough research has been done on compensating models to show this to be viable
  for any operations that are commutative and can be interleaved with other similar operations.  To enable compensation, servers should issue a
  <code>Link</code> header or <code>Link</code>
  element in responses with a <code>rel="trans"</code> (or some similar value) that clients can use to 1) <code>GET</code> the transaction's current state
  or; 2) <code>DELETE</code> an open transaction. 
</p>
<h4>Transactions</h4>
<p>
  There are several ways to support optional, discoverable, negotiable, optimistic, compenstated transactions. A trivial example might look like this (elided for brevity):
</p>
<pre class="code">
  *** REQUEST
  POST /orders/
  Host: www.example.org
  Accept-Trans: doctr
  
  *** RESPONSE
  HTTP/1.1 202 Accepted
  Location: http://www.example.org/orders/1
  Content-Trans:doctr
  Link &lt;http://www.example.org/trans/abc&gt;;rel=doctr;
  
  *** REQUEST  
  GET /trans/abc
  Host: www.example.org
  
  *** RESPONSE
  HTTP/1.1 200 OK
  
  ... body w/ details about the current transaction ...
  ... (open/closed, succeeded/failed, etc.) ...
  
  *** REQUEST 
  DELETE /trans/abc 
  Host: www.example.org
  
  *** RESPONSE
  HTTP/1.1 200 OK  

</pre>
<p>
  The advantages of this approach are 1) it's completely compatible w/ existing HTTP infrastructure; 2) it requires no additional request traffic forthe common case (2xx);
  3) it does not lock any existing resources; 4) it can be rolled out on existing servers w/o breaking clients; 5) clients and servers are free to ignore, negotiate, 
  and/or extend as desired; and 6) servers are free to continue to support any local transaction management they wish including ACID/2PC as long as it does not leak 
  out past the HTTP boundary to clients.
</p>
<p>
  There are details to work out, but they can be handled on the server where they belong. Clients only need to be able to negotiate for a transaction implementation
  and be prepared use the transaction <code>LINK</code> returned by the server when necessary. Servers, need to implement sagas locally and return the transaction
  <code>LINK</code>. They also need to implement support for cancel requests from the client and handle request failures from any "upstream" server enlisted in the unit of work.
</p>
<h4>A uniform interface</h4>
<p>
  What is described here is a <em>transaction service interface (TSI)</em> that clients and servers can choose to implement in ways all parties can agree upon. This is the way
  <a href="http://www.iana.org/assignments/media-types/" title="MIME Media Types">media-types</a>
  are currenly handled and TSIs could be defined, documented, and registered in much the same way. This includes the possibility of registering a media-type that matches the
  TSI implementation. True to the archetictural style of the HTTP protocol, this approach proposes
  a "uniform interface" for handling units of work over HTTP.
</p>
<p>
  The good news is that <em>clients</em> don't need to know about or understand in advance any details of the TSI in order to interact with a server that supports it.
  Servers, however, can start engaging in compensated transactions among themselves at any time as long as they agree on the TSI implementation.
  Eventually, as clients catch up and TSI implementations proliferate, servers and clients can engage in negotations for various types or levels of transaction
  support before initiating the work.
</p>
<h4>Someone call for a DOCTR?</h4>
<p>
  I'm currently working on a POC implementation I'm calling <b>DOCTR</b> (<b>D</b>iscoverable, <b>O</b>ptimistic, <b>C</b>ompensated, <b>TR</b>ansactions) [cute, eh?]. 
  I'll post my results for others to review as soon as I can. If all goes well and feedback is positive, I'll continue to pursue a formal description that can 
  stand up to further inspection.
</p>
</div>
          <p class="category"><a href="index.html%3Fcategory=5.html" title="more from code...">code</a></p>
          <hr><a id="comments"></a><script>
						var idcomments_acct = 'b941b488f39712a0d6409992a0d7fc47';
						var idcomments_post_id;
						var idcomments_post_url;
					</script><span id="IDCommentsPostTitle" style="display:none"></span><script type="text/javascript" src="http://www.intensedebate.com/js/genericCommentWrapperV2.js"></script></div>
        <div> </div>
      </div>
      <div id="sidebar">
        <h4>categories</h4>
        <ul>
          <li><a href="index.html%3Fcategory=33.html">Systems</a></li>
          <li><a href="index.html%3Fcategory=32.html">CA</a></li>
          <li><a href="index.html%3Fcategory=31.html">IoT</a></li>
          <li><a href="index.html%3Fcategory=30.html">ALPS</a></li>
          <li><a href="index.html%3Fcategory=29.html">API</a></li>
          <li>[<a href="../categories/index.html%3Fall.html" title="view all categories">all</a>]</li>
        </ul>
        <h4>websites</h4>
        <ul>
          <li><a href="../websites/32.html">Untangled</a></li>
          <li><a href="../websites/31.html">Anne’s Weblog</a></li>
          <li><a href="../websites/30.html">exyus</a></li>
          <li><a href="../websites/29.html">Random Stuff</a></li>
          <li><a href="../websites/28.html">JScript Blog</a></li>
          <li>[<a href="../websites/index.html%3Fall.html" title="view all websites">all</a>]</li>
        </ul>
        <h4>archives</h4>
        <ul>
          <li><a href="index.html%3Ftoday.html" title="today's posts">today</a></li>
          <li><a href="index.html%3Fyesterday.html" title="yesterday's posts">yesterday</a></li>
          <li><a href="index.html%3Fthisweek.html" title="this weeks's posts">this week</a></li>
          <li><a href="index.html%3Flastweek.html" title="last week's posts">last week</a></li>
          <li><a href="index.html%3Fthismonth.html" title="this month's posts">this month</a></li>
          <li><a href="index.html%3Flastmonth.html" title="last month's posts">last month</a></li>
          <li>
								[<a href="index.html" title="browse the archives">browse</a>]
							</li>
        </ul>
        <div> </div>
        <div><xscript type="text/javascript" src="http://plancast.com/goodies/widgets/sidebar/1/15731">// plancast</xscript></div>
        <div id="twitter_div">
          <h4>my tweets</h4>
          <ul id="twitter_update_list"></ul>
          <div class="twitter-link"><a href="http://twitter.com/mamund" title="follow me on Twitter">
									follow me
								</a></div>
          <hr class="empty">
        </div>
      </div>
      <div id="ads" style="text-align:center;"><script type="text/javascript">
							google_ad_client = "pub-2944238157647009";
							google_ad_width = 728;
							google_ad_height = 90;
							google_ad_format = "728x90_as";
							google_ad_type = "text";
							//2007-08-10: amundsen.com
							google_ad_channel = "2960096544";
							google_color_border = "000000";
							google_color_bg = "F0F0F0";
							google_color_link = "000000";
							google_color_text = "000000";
							google_color_url = "000000";
						</script><script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script></div>
      <div id="footer">
        <p>Copyright © 2007-2010 amundsen.com, inc. All rights reserved.</p>
      </div>
    </div><script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script><script type="text/javascript" src="http://twitter.com/statuses/user_timeline/mamund.json?callback=twitterCallback2&amp;count=5"></script><script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">
					_uacct = "UA-2399548-1";
					urchinTracker();
				</script></body>
</html>